(library
 (public_name quill.server)
 (name quill_server)
 (libraries
  unix
  jsont
  jsont.bytesrw
  cmdliner
  dream
  lwt
  quill_top
  quill_top_unix
  quill_api
  dune-site
  compiler-libs.toplevel))

(rule
 (target mode.txt)
 (enabled_if
  (<> %{profile} release))
 (action
  (with-stdout-to
   %{target}
   (echo "false"))))

(rule
 (target mode.txt)
 (enabled_if
  (= %{profile} release))
 (action
  (with-stdout-to
   %{target}
   (echo "true"))))

(rule
 (targets config.ml)
 (mode promote)
 (action
  (with-stdout-to
   %{targets}
   (echo "let is_release_mode = %{read-lines:./mode.txt}\n"))))

(rule
 (targets asset_editor.ml asset_editor.mli)
 (enabled_if
  (= %{profile} release))
 ; Only crunch in release mode
 (deps
  ../browser/styles.css
  ../browser/main.bc.wasm.js
  (source_tree ../browser/main.bc.wasm.assets))
 (action
  (run
   %{bin:quill-crunch}
   -e
   css
   -e
   js
   -e
   wasm
   -e
   map
   -o
   asset_editor.ml
   ../browser/)))

(rule
 (targets asset.ml asset.mli)
 (enabled_if
  (= %{profile} release))
 ; Only crunch in release mode
 (deps
  (source_tree asset/))
 (action
  (run %{bin:quill-crunch} -o asset.ml asset/)))

(rule
 (target asset_editor.ml)
 (enabled_if
  (<> %{profile} release))
 (deps
  ../browser/styles.css
  ../browser/main.bc.wasm.js
  (source_tree ../browser/main.bc.wasm.assets))
 ; Generate stub in dev mode
 (action
  (with-stdout-to
   %{target}
   (echo "(* Generated stub for dev mode *) \nlet read _ = None"))))

(rule
 (target asset.ml)
 (enabled_if
  (<> %{profile} release))
 (deps
  (source_tree asset/))
 ; Generate stub in dev mode
 (action
  (with-stdout-to
   %{target}
   (echo "(* Generated stub for dev mode *) \nlet read _ = None"))))

(rule
 (targets template_document.ml template_index.ml)
 (action
  (progn
   (run dream_eml %{dep:template_document.eml} --workspace %{workspace_root})
   (run dream_eml %{dep:template_index.eml} --workspace %{workspace_root}))))
